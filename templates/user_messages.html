{% extends 'base.html' %}
{% block title %} Messages {% endblock %}

{% block nav %}
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="{% url 'newcar' %}"><span class="fas fa-car-side"></span> New Added Car</a></li>
        <li><a href="{% url 'popularcar' %}"><span class="fas fa-star"></span> Popular Car</a></li>
        <li><a href="{% url 'contact' %}"><span class="fas fa-envelope"></span> Contact</a></li>
        <li><a href="{% url 'user_messages' %}"><span class="fas fa-comments"></span> Messages</a></li>
        <li><a href="{% url 'logout' %}"><span class="fas fa-sign-out-alt"></span> Logout</a></li>
      </ul>
    </div>
{% endblock %}

{% block body %}
<div class='container'>
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h4><strong><span class="fas fa-comments"></span> Contact Messages</strong></h4>
                </div>
                <div class="panel-body">
                    <!-- Search and Filter -->
                    <div class="row">
                        <div class="col-md-8">
                            <form method="GET" class="form-inline">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="Search messages..." value="{{query}}" name="q">
                                </div>
                                <div class="form-group">
                                    <select name="type" class="form-control">
                                        <option value="">All Types</option>
                                        {% for type_value, type_label in message_types %}
                                            <option value="{{ type_value }}" {% if type_value == selected_type %}selected{% endif %}>
                                                {{ type_label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary"><span class="fas fa-search"></span> Search</button>
                                <a href="{% url 'user_messages' %}" class="btn btn-secondary">Clear</a>
                            </form>
                        </div>
                        <div class="col-md-4 text-right">
                            <a href="{% url 'contact' %}" class="btn btn-success">
                                <span class="fas fa-plus"></span> Send New Message
                            </a>
                        </div>
                    </div>
                    <hr>

                    {% if messages_list %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Sender</th>
                                        <th>Subject</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Message</th>
                                        <th>Response</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for message in messages_list %}
                                    <tr>
                                        <td>
                                            <strong>{{ message.sender_name }}</strong><br>
                                            <small class="text-muted">{{ message.sender_email }}</small>
                                        </td>
                                        <td>{{ message.subject }}</td>
                                        <td>
                                            <span class="label label-info">{{ message.get_message_type_display }}</span>
                                        </td>
                                        <td>{{ message.created_at|date:"M d, Y H:i" }}</td>
                                        <td>
                                            {% if message.is_read %}
                                                <span class="label label-success">Read</span>
                                            {% else %}
                                                <span class="label label-warning">Unread</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="message-preview">
                                                {{ message.message|truncatewords:15 }}
                                                {% if message.message|length > 100 %}
                                                    <button class="btn btn-xs btn-link" onclick="toggleMessage({{ message.id }})">
                                                        <span id="toggle-{{ message.id }}">Show More</span>
                                                    </button>
                                                    <div id="full-message-{{ message.id }}" style="display: none;">
                                                        <hr>
                                                        <p>{{ message.message|linebreaks }}</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if message.response %}
                                                <div class="alert alert-info">
                                                    <strong>Response:</strong><br>
                                                    {{ message.response|linebreaks }}
                                                    {% if message.responded_at %}
                                                        <small class="text-muted">
                                                            <br>Responded: {{ message.responded_at|date:"M d, Y H:i" }}
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">No response yet</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if messages_list.has_other_pages %}
                            <nav aria-label="Page navigation">
                                <ul class="pagination">
                                    {% if messages_list.has_previous %}
                                        <li>
                                            <a href="?page={{ messages_list.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                    {% endif %}
                                    
                                    <li class="active">
                                        <span>Page {{ messages_list.number }} of {{ messages_list.paginator.num_pages }}</span>
                                    </li>
                                    
                                    {% if messages_list.has_next %}
                                        <li>
                                            <a href="?page={{ messages_list.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info text-center">
                            <h4><span class="fas fa-info-circle"></span> No Messages Found</h4>
                            <p>{% if query or selected_type %}No messages match your search criteria.{% else %}You haven't sent any messages yet.{% endif %}</p>
                            <a href="{% url 'contact' %}" class="btn btn-primary">
                                <span class="fas fa-envelope"></span> Send Your First Message
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleMessage(messageId) {
    const fullMessage = document.getElementById('full-message-' + messageId);
    const toggleText = document.getElementById('toggle-' + messageId);
    
    if (fullMessage.style.display === 'none') {
        fullMessage.style.display = 'block';
        toggleText.textContent = 'Show Less';
    } else {
        fullMessage.style.display = 'none';
        toggleText.textContent = 'Show More';
    }
}
</script>
{% endblock %}
